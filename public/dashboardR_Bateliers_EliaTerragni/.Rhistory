"60+ ans" = "#96CEB4"),
name = "Âge",
labels = function(x) {
sapply(x, function(age) {
total <- age_totals$total_age[age_totals$Classe_age == age]
paste0(age, " (n=", total, ")")
})
}
) +
labs(
title = "Répartition des modes de transport par âge",
x = NULL,
y = "Nombre d'enquêtés"
) +
theme_minimal() +
theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5, margin = margin(b = 10)),
axis.title.y = element_text(size = 12, face = "bold", margin = margin(r = 10)),
axis.text = element_text(size = 11),
axis.text.x = element_text(face = "bold", size = 11),
panel.grid.major.x = element_blank(),
panel.grid.minor.y = element_blank(),
panel.grid.major.y = element_line(color = "gray90", linewidth = 0.3),
panel.background = element_rect(fill = "white", color = NA),
plot.background = element_rect(fill = "white", color = NA),
legend.position = "right",
legend.title = element_text(size = 11, face = "bold"),
legend.text = element_text(size = 10)
) +
scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
})
output$bar_genre_plot <- renderPlot({
donnees_bar_genre <- enquete_data %>%
filter(!is.na(Mode_transport) & Mode_transport != "Non spécifié" &
!is.na(Genre) & Genre != "Non spécifié") %>%
group_by(Mode_transport, Genre) %>%
summarise(count = n(), .groups = 'drop') %>%
mutate(count = format_no_decimals(count)) %>%
group_by(Mode_transport) %>%
mutate(
total_mode = sum(count),
percent = round(count/total_mode * 100)
) %>%
ungroup() %>%
arrange(Mode_transport, desc(Genre)) %>%
group_by(Mode_transport) %>%
mutate(
ypos = cumsum(count) - 0.5 * count
) %>%
ungroup()
genre_totals <- donnees_bar_genre %>%
group_by(Genre) %>%
summarise(total_genre = sum(count), .groups = 'drop')
ggplot(donnees_bar_genre, aes(x = Mode_transport, y = count, fill = Genre)) +
geom_bar(stat = "identity", position = "stack", alpha = 0.9, color = "black", linewidth = 0.5) +
geom_text(
aes(y = ypos, label = count),
color = "white",
size = 4,
fontface = "bold",
vjust = 0.5
) +
geom_text(
data = donnees_bar_genre %>%
group_by(Mode_transport) %>%
summarise(total = sum(count), .groups = 'drop'),
aes(x = Mode_transport, y = total, label = paste("Total:", total)),
inherit.aes = FALSE,
vjust = -0.5,
color = "black",
size = 4,
fontface = "bold"
) +
scale_fill_manual(
values = c("Femme" = "#FF0000", "Homme" = "#3498DB"),
name = "Genre",
labels = function(x) {
sapply(x, function(g) {
total <- genre_totals$total_genre[genre_totals$Genre == g]
paste0(g, " (n=", total, ")")
})
}
) +
labs(
title = "Répartition des modes de transport par genre",
x = NULL,
y = "Nombre d'enquêtés"
) +
theme_minimal() +
theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5, margin = margin(b = 10)),
axis.title.y = element_text(size = 12, face = "bold", margin = margin(r = 10)),
axis.text = element_text(size = 11),
axis.text.x = element_text(face = "bold", size = 11),
panel.grid.major.x = element_blank(),
panel.grid.minor.y = element_blank(),
panel.grid.major.y = element_line(color = "gray90", linewidth = 0.3),
panel.background = element_rect(fill = "white", color = NA),
plot.background = element_rect(fill = "white", color = NA),
legend.position = "right",
legend.title = element_text(size = 11, face = "bold"),
legend.text = element_text(size = 10)
) +
scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
})
output$total_deplacements <- renderText({
req(enquete_data)
total <- nrow(enquete_data %>% filter(!is.na(Heure) & Heure != ""))
paste("Total des déplacements analysés :", total)
})
output$temp_plot <- renderPlot({
req(enquete_data)
if(input$categorie_selector == "motif") {
motif_col <- ifelse("Motif_deplacement" %in% names(enquete_data),
"Motif_deplacement",
ifelse("Motif" %in% names(enquete_data), "Motif", NA))
if(is.na(motif_col)) {
return(ggplot() +
annotate("text", x = 0.5, y = 0.5,
label = "Colonne 'Motif de déplacement' non trouvée",
size = 6) +
theme_void())
}
data_plot <- enquete_data %>%
mutate(
Heure_num = as.numeric(sub(":.*", "", Heure)),
Heure_num = ifelse(Heure_num >= 8 & Heure_num <= 19, Heure_num, NA)
) %>%
filter(!is.na(Heure_num)) %>%
mutate(
Categorie = case_when(
grepl("travail|études|travail/études", .data[[motif_col]], ignore.case = TRUE) ~ "Travail/Études",
grepl("promenade|loisir|activites/loisirs", .data[[motif_col]], ignore.case = TRUE) ~ "Loisirs/Promenade",
grepl("autre", .data[[motif_col]], ignore.case = TRUE) ~ "Autre",
.data[[motif_col]] %in% c("", "null", "NULL", "sans réponse", "sans reponse") ~ "Non spécifié",
TRUE ~ "Autre"
)
) %>%
group_by(Heure_num, Categorie) %>%
summarise(n = n(), .groups = 'drop') %>%
mutate(n = format_no_decimals(n)) %>%
group_by(Heure_num) %>%
mutate(
total_heure = sum(n),
pourcentage = round(n / total_heure * 100)
) %>%
ungroup() %>%
mutate(Categorie = factor(Categorie,
levels = c("Travail/Études", "Loisirs/Promenade", "Autre", "Non spécifié")))
couleurs <- c("Travail/Études" = "#3498DB",
"Loisirs/Promenade" = "#2ECC71",
"Autre" = "#F39C12",
"Non spécifié" = "#95A5A6")
titre <- "Répartition des motifs de déplacement par heure (8h-19h)"
legende <- "Motif"
} else if(input$categorie_selector == "transport") {
data_plot <- enquete_data %>%
mutate(
Heure_num = as.numeric(sub(":.*", "", Heure)),
Heure_num = ifelse(Heure_num >= 8 & Heure_num <= 19, Heure_num, NA)
) %>%
filter(!is.na(Heure_num) & !is.na(Mode_transport) & Mode_transport != "" & !grepl("sans|Sans|null|NULL", Mode_transport, ignore.case = TRUE)) %>%
mutate(
Categorie = case_when(
grepl("piéton|pieton", Mode_transport, ignore.case = TRUE) ~ "Piéton",
grepl("cycliste|cycl", Mode_transport, ignore.case = TRUE) ~ "Cycliste",
TRUE ~ "Autre"
)
) %>%
group_by(Heure_num, Categorie) %>%
summarise(n = n(), .groups = 'drop') %>%
mutate(n = format_no_decimals(n)) %>%
group_by(Heure_num) %>%
mutate(
total_heure = sum(n),
pourcentage = round(n / total_heure * 100)
) %>%
ungroup() %>%
mutate(Categorie = factor(Categorie,
levels = c("Piéton", "Cycliste", "Autre")))
couleurs <- c("Piéton" = "#3498DB",
"Cycliste" = "#2ECC71",
"Autre" = "#F39C12")
titre <- "Répartition des modes de transport par heure (8h-19h)"
legende <- "Mode de transport"
} else if(input$categorie_selector == "age") {
data_plot <- enquete_data %>%
mutate(
Heure_num = as.numeric(sub(":.*", "", Heure)),
Heure_num = ifelse(Heure_num >= 8 & Heure_num <= 19, Heure_num, NA)
) %>%
filter(!is.na(Heure_num) & !is.na(Classe_age) & Classe_age != "Non spécifié") %>%
mutate(
Categorie = Classe_age
) %>%
group_by(Heure_num, Categorie) %>%
summarise(n = n(), .groups = 'drop') %>%
mutate(n = format_no_decimals(n)) %>%
group_by(Heure_num) %>%
mutate(
total_heure = sum(n),
pourcentage = round(n / total_heure * 100)
) %>%
ungroup() %>%
mutate(Categorie = factor(Categorie,
levels = c("0-20 ans", "20-40 ans", "40-60 ans", "60+ ans")))
couleurs <- c("0-20 ans" = "#FF6B6B",
"20-40 ans" = "#4ECDC4",
"40-60 ans" = "#45B7D1",
"60+ ans" = "#96CEB4")
titre <- "Répartition par classe d'âge par heure (8h-19h)"
legende <- "Classe d'âge"
} else if(input$categorie_selector == "genre") {
data_plot <- enquete_data %>%
mutate(
Heure_num = as.numeric(sub(":.*", "", Heure)),
Heure_num = ifelse(Heure_num >= 8 & Heure_num <= 19, Heure_num, NA)
) %>%
filter(!is.na(Heure_num) & !is.na(Genre) & Genre != "Non spécifié") %>%
mutate(
Categorie = Genre
) %>%
group_by(Heure_num, Categorie) %>%
summarise(n = n(), .groups = 'drop') %>%
mutate(n = format_no_decimals(n)) %>%
group_by(Heure_num) %>%
mutate(
total_heure = sum(n),
pourcentage = round(n / total_heure * 100)
) %>%
ungroup() %>%
mutate(Categorie = factor(Categorie,
levels = c("Femme", "Homme")))
couleurs <- c("Femme" = "#FF0000", "Homme" = "#3498DB")
titre <- "Répartition par genre par heure (8h-19h)"
legende <- "Genre"
}
if(nrow(data_plot) == 0) {
return(ggplot() +
annotate("text", x = 0.5, y = 0.5,
label = "Aucune donnée disponible pour la période 8h-19h",
size = 6) +
theme_void())
}
ggplot(data_plot, aes(x = factor(Heure_num), y = pourcentage, fill = Categorie)) +
geom_bar(stat = "identity", position = "fill", width = 0.7) +
scale_fill_manual(values = couleurs, name = legende) +
geom_text(aes(label = ifelse(pourcentage > 10, paste0(pourcentage, "%"), "")),
position = position_fill(vjust = 0.5),
color = "white",
size = 3.5,
fontface = "bold") +
geom_text(data = data_plot %>%
group_by(Heure_num) %>%
summarise(total = first(total_heure), .groups = 'drop'),
aes(x = factor(Heure_num), y = 1.05, label = paste("n =", total)),
inherit.aes = FALSE,
size = 3.5,
fontface = "bold",
color = "#2C3E50") +
labs(
title = titre,
x = "Heure",
y = "Pourcentage (%)",
caption = "Données de l'enquête Co-Move 2025"
) +
theme_minimal() +
theme(
plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
axis.title.x = element_text(size = 14, face = "bold", margin = margin(t = 10)),
axis.title.y = element_text(size = 14, face = "bold", margin = margin(r = 10)),
axis.text.x = element_text(size = 12, angle = 0, hjust = 0.5),
axis.text.y = element_text(size = 11),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
panel.grid.major.y = element_line(color = "gray90", linewidth = 0.5),
panel.background = element_rect(fill = "white", color = NA),
plot.background = element_rect(fill = "white", color = NA),
plot.caption = element_text(size = 10, color = "gray60", hjust = 1, margin = margin(t = 10)),
legend.position = "bottom",
legend.title = element_text(size = 12, face = "bold"),
legend.text = element_text(size = 11),
legend.key.size = unit(0.8, "cm")
) +
scale_x_discrete(labels = function(x) paste0(x, "h")) +
scale_y_continuous(labels = scales::percent_format(scale = 1),
expand = expansion(mult = c(0, 0.15)),
breaks = seq(0, 100, by = 25))
})
nettoyer_ressenti <- function(data) {
data %>%
mutate(
Sentiment_securite = case_when(
tolower(Sentiment_securite) %in% c("tout à fait d'accord", "tout a fait d'accord") ~ "Sécurité élevée",
tolower(Sentiment_securite) %in% c("plutôt d'accord", "plutot d'accord") ~ "Sécurité moyenne",
tolower(Sentiment_securite) %in% c("plutôt pas d'accord", "plutot pas d'accord") ~ "Sécurité faible",
tolower(Sentiment_securite) %in% c("pas du tout d'accord") ~ "Insécurité",
tolower(Sentiment_securite) %in% c("ne sait pas", "sans reponse", "null", "") ~ "Non spécifié",
TRUE ~ "Non spécifié"
),
Perception_risque_collision_pietons_cyclistes = case_when(
tolower(Perception_risque_collision_pietons_cyclistes) %in% c("tout à fait d'accord", "tout a fait d'accord") ~ "Risque très faible",
tolower(Perception_risque_collision_pietons_cyclistes) %in% c("plutôt d'accord", "plutot d'accord") ~ "Risque faible",
tolower(Perception_risque_collision_pietons_cyclistes) %in% c("plutôt pas d'accord", "plutot pas d'accord") ~ "Risque moyen",
tolower(Perception_risque_collision_pietons_cyclistes) %in% c("pas du tout d'accord") ~ "Risque élevé",
tolower(Perception_risque_collision_pietons_cyclistes) %in% c("ne sait pas", "sans reponse", "null", "") ~ "Non spécifié",
TRUE ~ "Non spécifié"
),
Perception_tensions = case_when(
tolower(Perception_tensions) %in% c("tout à fait d'accord", "tout a fait d'accord") ~ "Tensions fortes",
tolower(Perception_tensions) %in% c("plutôt d'accord", "plutot d'accord") ~ "Tensions moyennes",
tolower(Perception_tensions) %in% c("plutôt pas d'accord", "plutot pas d'accord") ~ "Tensions faibles",
tolower(Perception_tensions) %in% c("pas du tout d'accord") ~ "Pas de tensions",
tolower(Perception_tensions) %in% c("ne sait pas", "sans reponse", "null", "") ~ "Non spécifié",
TRUE ~ "Non spécifié"
),
Frequence_clean = case_when(
tolower(Frequence) %in% c("tous les jours", "tous les jours") ~ "Quotidien",
tolower(Frequence) %in% c("toutes les semaines", "toutes les semaines") ~ "Hebdomadaire",
tolower(Frequence) %in% c("moins souvent") ~ "Occasionnel",
tolower(Frequence) %in% c("premiere fois") ~ "Première fois",
tolower(Frequence) %in% c("sans reponse", "null", "") ~ "Non spécifié",
TRUE ~ as.character(Frequence)
)
)
}
generate_bubble_plot <- function(data, var_name, facet_var, title) {
data_prep <- data %>%
mutate(
var_value = case_when(
var_name == "Sentiment_securite" ~ Sentiment_securite,
var_name == "Perception_risque_collision_pietons_cyclistes" ~ Perception_risque_collision_pietons_cyclistes,
var_name == "Perception_tensions" ~ Perception_tensions,
TRUE ~ Sentiment_securite
)
) %>%
filter(!is.na(var_value) & var_value != "Non spécifié")
if(facet_var == "Mode_transport") {
data_prep <- data_prep %>%
filter(!is.na(Mode_transport) & Mode_transport != "Non spécifié") %>%
group_by(Mode_transport, var_value) %>%
summarise(count = n(), .groups = 'drop') %>%
mutate(count = format_no_decimals(count))
fill_var <- "Mode_transport"
transport_levels <- unique(data_prep$Mode_transport)
colors <- setNames(
c("#3498DB", "#E74C3C", "#2ECC71", "#9B59B6", "#F39C12")[1:length(transport_levels)],
transport_levels
)
} else if(facet_var == "Genre") {
data_prep <- data_prep %>%
filter(!is.na(Genre) & Genre != "Non spécifié") %>%
group_by(Genre, var_value) %>%
summarise(count = n(), .groups = 'drop') %>%
mutate(count = format_no_decimals(count))
fill_var <- "Genre"
colors <- c("Femme" = "#FF0000", "Homme" = "#2ECC71")
} else if(facet_var == "Frequence_clean") {
data_prep <- data_prep %>%
filter(!is.na(Frequence_clean) & Frequence_clean != "Non spécifié") %>%
group_by(Frequence_clean, var_value) %>%
summarise(count = n(), .groups = 'drop') %>%
mutate(count = format_no_decimals(count))
fill_var <- "Frequence_clean"
colors <- c("Quotidien" = "#E67E22", "Hebdomadaire" = "#1ABC9C",
"Occasionnel" = "#F1C40F", "Première fois" = "#E74C3C")
} else if(facet_var == "Classe_age") {
data_prep <- data_prep %>%
filter(!is.na(Classe_age) & Classe_age != "Non spécifié") %>%
group_by(Classe_age, var_value) %>%
summarise(count = n(), .groups = 'drop') %>%
mutate(count = format_no_decimals(count))
fill_var <- "Classe_age"
colors <- c("0-20 ans" = "#FF6B6B", "20-40 ans" = "#4ECDC4",
"40-60 ans" = "#45B7D1", "60+ ans" = "#96CEB4")
}
data_prep <- data_prep %>%
filter(count > 0)
if(var_name == "Sentiment_securite") {
data_prep <- data_prep %>%
mutate(var_value = factor(var_value,
levels = c("Insécurité", "Sécurité faible",
"Sécurité moyenne", "Sécurité élevée")))
} else if(var_name == "Perception_risque_collision_pietons_cyclistes") {
data_prep <- data_prep %>%
mutate(var_value = factor(var_value,
levels = c("Risque très faible", "Risque faible",
"Risque moyen", "Risque élevé")))
} else if(var_name == "Perception_tensions") {
data_prep <- data_prep %>%
mutate(var_value = factor(var_value,
levels = c("Pas de tensions", "Tensions faibles",
"Tensions moyennes", "Tensions fortes")))
}
max_count <- max(data_prep$count, na.rm = TRUE)
size_range <- if(max_count > 50) c(10, 25) else c(8, 20)
p <- ggplot(data_prep, aes(x = var_value, y = count)) +
geom_point(aes(size = count, color = !!sym(fill_var)), alpha = 0.7) +
geom_text(aes(label = count), size = 3.5, vjust = -1.5, fontface = "bold") +
scale_size_continuous(
name = "Nombre\nd'observations",
range = size_range,
breaks = function(x) {
if(length(unique(x)) > 1) {
pretty(x, n = min(4, length(unique(x))))
} else {
unique(x)
}
}
) +
scale_color_manual(
values = colors,
name = ifelse(facet_var == "Frequence_clean", "Fréquence",
ifelse(facet_var == "Classe_age", "Âge",
ifelse(facet_var == "Genre", "Genre", "Mode de transport")))
) +
labs(
title = title,
x = switch(var_name,
"Sentiment_securite" = "Sentiment de sécurité",
"Perception_risque_collision_pietons_cyclistes" = "Perception du risque de collision",
"Perception_tensions" = "Perception des tensions"),
y = "Nombre d'observations"
) +
theme_minimal() +
theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5, margin = margin(b = 15)),
axis.title.x = element_text(size = 12, face = "bold", margin = margin(t = 10)),
axis.title.y = element_text(size = 12, face = "bold", margin = margin(r = 10)),
axis.text.x = element_text(size = 11, angle = 0, hjust = 0.5, vjust = 1),
axis.text.y = element_text(size = 10),
legend.position = "right",
legend.title = element_text(size = 10, face = "bold"),
legend.text = element_text(size = 9),
legend.box = "vertical",
legend.margin = margin(l = 0, r = 0),
legend.spacing.y = unit(0.2, "cm"),
panel.grid.major = element_line(color = "gray90", linewidth = 0.2),
panel.grid.minor = element_blank(),
panel.background = element_rect(fill = "white", color = NA),
plot.background = element_rect(fill = "white", color = NA),
plot.margin = margin(10, 20, 10, 10)
) +
guides(
color = guide_legend(
override.aes = list(size = 4),
title.position = "top",
title.hjust = 0.5
),
size = guide_legend(
title.position = "top",
title.hjust = 0.5
)
) +
scale_y_continuous(
limits = c(0, max(data_prep$count) * 1.3),
expand = expansion(mult = c(0.05, 0.15))
)
return(p)
}
output$ressenti_mode_plot <- renderPlot({
req(enquete_data, input$var_mode)
data_clean <- nettoyer_ressenti(enquete_data) %>%
filter(Mode_transport != "Non spécifié")
generate_bubble_plot(
data = data_clean,
var_name = input$var_mode,
facet_var = "Mode_transport",
title = "Distribution du ressenti par mode de transport"
)
})
output$ressenti_genre_plot <- renderPlot({
req(enquete_data, input$var_genre)
data_clean <- nettoyer_ressenti(enquete_data) %>%
filter(Genre != "Non spécifié")
generate_bubble_plot(
data = data_clean,
var_name = input$var_genre,
facet_var = "Genre",
title = "Distribution du ressenti par genre"
)
})
output$ressenti_freq_plot <- renderPlot({
req(enquete_data, input$var_freq)
data_clean <- nettoyer_ressenti(enquete_data) %>%
filter(Frequence_clean != "Non spécifié")
generate_bubble_plot(
data = data_clean,
var_name = input$var_freq,
facet_var = "Frequence_clean",
title = "Distribution du ressenti par fréquence d'utilisation"
)
})
output$ressenti_age_plot <- renderPlot({
req(enquete_data, input$var_age)
data_clean <- nettoyer_ressenti(enquete_data) %>%
filter(Classe_age != "Non spécifié")
generate_bubble_plot(
data = data_clean,
var_name = input$var_age,
facet_var = "Classe_age",
title = "Distribution du ressenti par classe d'âge"
)
})
}
shinyApp(ui = ui, server = server)
runApp('script_dashboard.R')
runApp('script_dashboard.R')
runApp('script_dashboard.R')
runApp('script_dashboard.R')
runApp('script_dashboard.R')
library(shiny); runApp('script_dashboard.R')
